<link rel="ractive" href="../r-page-globalping.html" name="r-page">
<link rel="ractive" href="../components/header.html" name="c-header">
<link rel="ractive" href="../components/footer.html" name="c-footer">
<link rel="ractive" href="../components/notification.html" name="c-notification">
<link rel="ractive" href="../components/controlled-input.html" name="c-controlled-input">
<link rel="ractive" href="../components/gp-test-results.html" name="c-gp-test-results">
<link rel="ractive" href="../components/gp-top-navigation.html" name="c-gp-top-navigation">
<link rel="ractive" href="../components/gp-jumbotron.html" name="c-gp-jumbotron">

<r-page noYield="{{noYield}}" title="{{title}}" description="{{description}}">
	<script src='https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css' rel='stylesheet' />

	<c-notification></c-notification>

	<c-header additionalClasses="header-with-globalping-bg"></c-header>

	<div class="p-globalping">
		<c-gp-top-navigation useDarkBg="true" currentName="globalping"></c-gp-top-navigation>

		<c-gp-jumbotron className="main"></c-gp-jumbotron>

		<div class="gp_main-info">
			<div class="gp_main-info_descr">
				<span class="gp_main-info_descr_green">Monitor, debug and benchmark</span> your internet infrastructure from a globally distributed
				network of probes.
			</div>

			<div class="gp_main-info_stats">
				<div class="gp_main-info_stats_item">
					<span class="gp_main-info_stats_item_number">
						{{ Math.floor(totalProbes) }}
						<span></span>
					</span>
					<span class="gp_main-info_stats_item_text">connected probes</span>
				</div>

				<div class="gp_main-info_stats_item">
					<span class="gp_main-info_stats_item_number">
						{{ Math.floor(totalCities) }}
						<span></span>
					</span>
					<span class="gp_main-info_stats_item_text">different cities</span>
				</div>

				<div class="gp_main-info_stats_item">
					<span class="gp_main-info_stats_item_number">
						{{ Math.floor(totalCountries) }}
						<span></span>
					</span>
					<span class="gp_main-info_stats_item_text">different countries</span>
				</div>
			</div>
		</div>

		<div class="gp_map-block">
			<div class="gp_map-block_header">
				<span></span>
				<span></span>
				<span></span>
			</div>

			<div class="gp_map-block_map-wrapper {{#unless showMap}}gp_map-block_map-wrapper_hidden{{/unless}}">
				<div id="gp-map" class="gp_map-block_map-wrapper_map"></div>

				{{#if probesMinMaxTimings}}
					<div class="gp_map-block_map-wrapper_timings-scale">
						<span class="value">{{probesMinMaxTimings.max}}ms</span>
						<div class="gradient"></div>
						<span class="value">{{probesMinMaxTimings.min}}ms</span>
					</div>
				{{/if}}
			</div>

			<div class="gp_map-block_demo-tools">
				<div class="gp_map-block_demo-tools_settings">
					<div class="gp_dropdown_reg">
						<span>Test type</span>

						<div class="btn-group">
							<button type="button"
								class="dropdown-toggle"
								data-toggle="dropdown"
								aria-haspopup="true"
								aria-expanded="false">
								<span>{{~/mainOptions.type}}</span>
								<i class="fa fa-angle-down" aria-hidden="true"></i>
							</button>

							<div class="dropdown-menu">
								{{#each ~/testTypesList}}
									<div on-click="@this.set('mainOptions.type', this)">{{this}}</div>
								{{/each}}
							</div>
						</div>
					</div>

					<c-controlled-input
						value="{{mainOptions.target}}"
						error="{{inputErrors.target}}"
						placeholder="e.g. IP or domain"
						labelText="Target"
						classList="gp_map-block_demo-tools_settings_target gp_input">
					</c-controlled-input>

					<c-controlled-input
						value="{{mainOptions.location}}"
						error="{{inputErrors.location}}"
						placeholder="Enter location"
						labelText="Location"
						classList="gp_map-block_demo-tools_settings_location gp_input">
						{{#partial labelIcon}}
							<img as-tooltip="'TODO: how to use location'"
								width="14"
								height="14"
								src="{{@shared.assetsHost}}/img/globalping/help-icon.svg">
						{{/partial}}
					</c-controlled-input>

					<div class="gp_map-block_demo-tools_settings_grouped">
						<c-controlled-input
							value="{{mainOptions.limit}}"
							error="{{inputErrors.limit}}"
							placeholder="{{defaultLimit}}"
							labelText="Limit"
							classList="gp_map-block_demo-tools_settings_limit gp_input">
						</c-controlled-input>

						<div class="gp_map-block_demo-tools_settings_grouped_options-block">
							<button class="{{#if showMeasurementOpts}}active{{/if}}"
								on-click="@this.toggle('showMeasurementOpts')">
								<img width="20"
									height="20"
									src="{{@shared.assetsHost}}/img/globalping/settings-icon.svg">

								<div class="additional-opts-total">{{mainOptions.additionalOptsTotal}}</div>
							</button>

							<div class="gp_map-block_demo-tools_settings_grouped_options-block_specific-set">
								{{#if mainOptions.type === 'ping'}}
									<div class="typePing">
										<c-controlled-input
											value="{{notAppliedOpts.packets}}"
											error="{{inputErrors['measurementOptions.packets']}}"
											placeholder="{{defaultPacketsAmount}}"
											labelText="Packets"
											classList="gp_input">
										</c-controlled-input>
									</div>
								{{/if}}

								{{#if mainOptions.type === 'traceroute'}}
									<div class="typeTraceroute">
										<div class="pair">
											<c-controlled-input
												value="{{notAppliedOpts.port}}"
												error="{{inputErrors['measurementOptions.port']}}"
												placeholder="53"
												labelText="Port"
												classList="port-input gp_input">
											</c-controlled-input>

											<div class="gp_dropdown_reg">
												<span>Protocol</span>

												<div class="btn-group">
													<button type="button"
														class="dropdown-toggle"
														data-toggle="dropdown"
														aria-haspopup="true"
														aria-expanded="false">
														<span>{{~/tracerouteOpts.protocol}}</span>
														<i class="fa fa-angle-down" aria-hidden="true"></i>
													</button>

													<div class="dropdown-menu">
														<div on-click="@this.set('tracerouteOpts.protocol', 'TCP')">TCP</div>
														<div on-click="@this.set('tracerouteOpts.protocol', 'UDP')">UDP</div>
														<div on-click="@this.set('tracerouteOpts.protocol', 'ICMP')">ICMP</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								{{/if}}

								{{#if mainOptions.type === 'DNS'}}
									<div class="typeDNS">
										<div class="rows">
											<div class="rows_row-one">
												<c-controlled-input
													value="{{notAppliedOpts.port}}"
													error="{{inputErrors['measurementOptions.port']}}"
													placeholder="53"
													labelText="Port"
													classList="port-input gp_input">
												</c-controlled-input>

												<div class="gp_dropdown_reg">
													<span>Protocol</span>

													<div class="btn-group">
														<button type="button"
															class="dropdown-toggle"
															data-toggle="dropdown"
															aria-haspopup="true"
															aria-expanded="false">
															<span>{{~/dnsOpts.protocol}}</span>
															<i class="fa fa-angle-down" aria-hidden="true"></i>
														</button>

														<div class="dropdown-menu">
															<div on-click="@this.set('dnsOpts.protocol', 'UDP')">UDP</div>
															<div on-click="@this.set('dnsOpts.protocol', 'TCP')">TCP</div>
														</div>
													</div>
												</div>
											</div>

											<div class="rows_row-two">
												<div class="gp_dropdown_reg">
													<span>Type</span>

													<div class="btn-group">
														<button type="button"
															class="dropdown-toggle"
															data-toggle="dropdown"
															aria-haspopup="true"
															aria-expanded="false">
															<span>{{~/dnsOpts.query.type}}</span>
															<i class="fa fa-angle-down" aria-hidden="true"></i>
														</button>

														<div class="dropdown-menu">
															{{#each ~/dnsTypesList}}
																<div on-click="@this.set('dnsOpts.query.type', this)">{{this}}</div>
															{{/each}}
														</div>
													</div>
												</div>

												<div class="rows_row-two_switch-block">
													<label class="gp_switch">
														<input type="checkbox" on-click="@this.set('dnsOpts.trace', !dnsOpts.trace)" checked="{{dnsOpts.trace}}">
														<span class="slider round"></span>
													</label>

													<span>Trace</span>
												</div>
											</div>
										</div>

										<c-controlled-input
											value="{{notAppliedOpts.resolver}}"
											error="{{inputErrors['measurementOptions.resolver']}}"
											placeholder="IP address"
											labelText="Resolver"
											classList="resolver-input gp_input">
										</c-controlled-input>
									</div>
								{{/if}}

								{{#if mainOptions.type === 'MTR'}}
									<div class="typeMTR">
										<div class="pair">
											<c-controlled-input
												value="{{notAppliedOpts.port}}"
												error="{{inputErrors['measurementOptions.port']}}"
												placeholder="53"
												labelText="Port"
												classList="port-input gp_input">
											</c-controlled-input>

											<div class="gp_dropdown_reg">
												<span>Protocol</span>

												<div class="btn-group">
													<button type="button"
														class="dropdown-toggle"
														data-toggle="dropdown"
														aria-haspopup="true"
														aria-expanded="false">
														<span>{{~/mtrOpts.protocol}}</span>
														<i class="fa fa-angle-down" aria-hidden="true"></i>
													</button>

													<div class="dropdown-menu">
														<div on-click="@this.set('mtrOpts.protocol', 'UDP')">UDP</div>
														<div on-click="@this.set('mtrOpts.protocol', 'TCP')">TCP</div>
														<div on-click="@this.set('mtrOpts.protocol', 'ICMP')">ICMP</div>
													</div>
												</div>
											</div>
										</div>

										<c-controlled-input
											value="{{notAppliedOpts.packets}}"
											error="{{inputErrors['measurementOptions.packets']}}"
											placeholder="{{defaultPacketsAmount}}"
											labelText="Packets"
											classList="gp_input">
										</c-controlled-input>
									</div>
								{{/if}}

								{{#if mainOptions.type === 'HTTP'}}
									<div class="typeHTTP">
										<c-controlled-input
											value="{{notAppliedOpts.host}}"
											error="{{inputErrors['measurementOptions.request.host']}}"
											placeholder="Host"
											labelText="Host"
											classList="gp_input">
										</c-controlled-input>

										<c-controlled-input
											value="{{notAppliedOpts.path}}"
											error="{{inputErrors['measurementOptions.request.path']}}"
											placeholder="Path"
											labelText="Path"
											classList="gp_input">
										</c-controlled-input>

										<c-controlled-input
											value="{{notAppliedOpts.query}}"
											error="{{inputErrors['measurementOptions.request.query']}}"
											placeholder="Query"
											labelText="Query"
											classList="gp_input">
										</c-controlled-input>

										<div class="pair">
											<c-controlled-input
												value="{{notAppliedOpts.port}}"
												error="{{inputErrors.port}}"
												placeholder="53"
												labelText="Port"
												classList="port-input gp_input">
											</c-controlled-input>

											<div class="gp_dropdown_reg">
												<span>Protocol</span>

												<div class="btn-group">
													<button type="button"
														class="dropdown-toggle"
														data-toggle="dropdown"
														aria-haspopup="true"
														aria-expanded="false">
														<span>{{~/httpOpts.protocol}}</span>
														<i class="fa fa-angle-down" aria-hidden="true"></i>
													</button>

													<div class="dropdown-menu">
														<div on-click="@this.set('httpOpts.protocol', 'HTTP')">HTTP</div>
														<div on-click="@this.set('httpOpts.protocol', 'HTTPS')">HTTPS</div>
														<div on-click="@this.set('httpOpts.protocol', 'HTTP2')">HTTP2</div>
													</div>
												</div>
											</div>
										</div>

										<div class="gp_dropdown_reg">
											<span>Method</span>

											<div class="btn-group">
												<button type="button"
													class="dropdown-toggle"
													data-toggle="dropdown"
													aria-haspopup="true"
													aria-expanded="false">
													<span>{{~/httpOpts.request.method}}</span>
													<i class="fa fa-angle-down" aria-hidden="true"></i>
												</button>

												<div class="dropdown-menu">
													<div on-click="@this.set('httpOpts.request.method', 'GET')">GET</div>
													<div on-click="@this.set('httpOpts.request.method', 'HEAD')">HEAD</div>
												</div>
											</div>
										</div>

										<c-controlled-input
											value="{{notAppliedOpts.resolver}}"
											error="{{inputErrors['measurementOptions.resolver']}}"
											placeholder="Resolver"
											labelText="Resolver"
											classList="gp_input">
										</c-controlled-input>
									</div>
								{{/if}}

								<button class="gp_btn_green" on-click="@this.applyOptions()">
									Apply
								</button>
							</div>
						</div>

						<div class="gp_map-block_demo-tools_settings_grouped_switch-block">
							<label class="gp_switch">
								<input type="checkbox" on-click="@this.set('showMap', !showMap)" checked>
								<span class="slider round"></span>
							</label>

							<span>Map</span>
						</div>
					</div>

					<button on-click="@this.proceedToTest()"
						class="gp_map-block_demo-tools_settings_btn gp_btn_green {{#if testInProgress}}gp_btn_green_disabled gp_btn_green_loading{{/if}}"
						disabled="{{testInProgress}}">
						{{#if testInProgress}}
							<div></div>
							<div></div>
							<div></div>
							<div></div>
						{{else}}
							Run test
						{{/if}}
					</button>
				</div>

				{{#if testFailed}}
					<div class="gp_map-block_demo-tools_fail-msg">
						<img width="56"
							height="56"
							src="{{@shared.assetsHost}}/img/globalping/fail-icon-big.svg">

						<p>
							All tests failed. Maybe you specified a non existing endpoint?
						</p>
					</div>
				{{elseif testResults}}
					<c-gp-test-results testType="{{mainOptions.type}}" testResults="{{testResults}}" dnsTraceEnabled="{{dnsTraceEnabled}}"></c-gp-test-results>
				{{else}}
					<div class="gp_map-block_demo-tools_info">
						<img width="56"
							height="56"
							src="{{@shared.assetsHost}}/img/globalping/bulb-icon.svg">

						<p>
							Run a global latency test! Benchmark your CDN provider and understand how the network performs!
							Compare DNS providers to find the fastest one globally or in your region.
							Run network tests globally or from specific locations and regions.
							Debug and troubleshoot your networking problems and share the test results with others!
						</p>
					</div>
				{{/if}}
			</div>
		</div>

		<div class="gp_features">
			<div class="gp_features_item">
				<span class="gp_features_item_icon">
					<img width="48"
						height="48"
						src="{{@shared.assetsHost}}/img/globalping/globalping-opensource-icon.svg">
				</span>
				<span class="gp_features_item_name">
					Fully open source and free
				</span>
				<span class="gp_features_item_descr">
					Every component of Globalping is open source and is being actively developed on GitHub with the help of our community and users.
				</span>
			</div>

			<div class="gp_features_item">
				<span class="gp_features_item_icon">
					<img width="48"
						height="48"
						src="{{@shared.assetsHost}}/img/globalping/globalping-nonprofit-icon.svg">
					</span>
				<span class="gp_features_item_name">
					Developed by jsDelivr
				</span>
				<span class="gp_features_item_descr">
					The Globalping platform is developed by the jsDelivr team who has more than 10 years of experience maintaining the jsDelivr CDN which is being used by millions of website around the globe.
				</span>
			</div>

			<div class="gp_features_item">
				<span class="gp_features_item_icon">
					<img width="48"
						height="48"
						src="{{@shared.assetsHost}}/img/globalping/globalping-community-icon.svg">
					</span>
				<span class="gp_features_item_name">
					Powered by community and sponsors
				</span>
				<span class="gp_features_item_descr">
					The jsDelivr organization and all projects including Globalping rely on our corporate and GitHub sponsors. Consider joining them to help us release new features even faster!
				</span>
			</div>

			<div class="gp_features_item">
				<span class="gp_features_item_icon">
					<img width="48"
						height="48"
						src="{{@shared.assetsHost}}/img/globalping/globalping-security-icon.svg">
				</span>
				<span class="gp_features_item_name">
					Secure and private
				</span>
				<span class="gp_features_item_descr">
					The security of our systems and privacy of our users are of the utmost importance for us. We minimize the public information that our probes expose and block harmful and abusive domains and IPs.
				</span>
			</div>
		</div>

		<div class="gp_installation">
			<a href="/globalping/cli" class="gp_installation_item">
				<img width="61"
					height="53"
					src="{{@shared.assetsHost}}/img/globalping/cli-icon.svg">

				<span class="gp_installation_item_title">
					Install the Globalping CLI
				</span>

				<span class="gp_installation_item_descr">
					The jsDelivr organization and all projects including Globalping rely on our corporate and GitHub sponsors.
				</span>
			</a>

			<a target="_blank" rel="noopener noreferrer" href="https://github.com/jsdelivr/globalping#globalping-rest-api" class="gp_installation_item">
				<img width="61"
					height="53"
					src="{{@shared.assetsHost}}/img/globalping/rest-api-icon.svg">

				<span class="gp_installation_item_title">
					Integrate the Globalping REST API
				</span>

				<span class="gp_installation_item_descr">
					Use our free API to build your own tools, automated your tests and integrate Globalping into your existing flow
				</span>
			</a>

			<a href="/globalping/slack" class="gp_installation_item">
				<img width="61"
					height="53"
					src="{{@shared.assetsHost}}/img/globalping/slack-icon.svg">

				<span class="gp_installation_item_title">
					Install the Globalping Slack App
				</span>

				<span class="gp_installation_item_descr">
					Install the app into your Slack organization to allow all of your members to run global tests in any channel
				</span>
			</a>
		</div>

		<div class="gp_join-network">
			<span class="gp_join-network_title">Join the network</span>
			<span class="gp_join-network_subtitle">
				To join the Globalping probe network all you have to do is run our container.
			</span>

			<div class="gp_join-network_docker">
				<span class="gp_join-network_docker_command">
					{{netDockerCmdText}}
				</span>

				<button class="gp_join-network_docker_btn gp_btn_green" as-clipboard data-clipboard-text="{{netDockerCmdText}}">
					<img width="20"
						height="20"
						src="{{@shared.assetsHost}}/img/globalping/copy-icon.svg">
				</button>
			</div>

			<span class="gp_join-network_descr">
				Once you connect you will become part of the global community that powers the Globalping Platform.
				The container will work on both x86 and ARM architectures.
			</span>

			<a target="_blank"
				rel="noopener noreferrer"
				href="https://github.com/jsdelivr/globalping-probe"
				class="gp_join-network_btn gp_btn_green">
				Learn more
			</a>
		</div>

		<div class="gp_join-community">
			<div class="gp_join-community_content">
				<span class="gp_join-community_content_title">
					We invite everyone to join our community and help us develop our projects.
				</span>

				<ul class="gp_join-community_content_list">
					<li>We promise a friendly discussion in our issues and code reviews</li>
					<li>We appreciate your work and will review your PRs in a timely manner</li>
					<li>We are open to new ideas and technologies</li>
					<li>You don't have to be a developer to help</li>
					<li>Copyrighters, community moderators, dev relations, media relations... are all equally important</li>
				</ul>
			</div>
		</div>

		<div class="gp_gh-links">
			<div class="gp_gh-links_header">
				<span class="gp_gh-links_header_title">Become an open source contributor!</span>

				<img width="64"
					height="64"
					src="{{@shared.assetsHost}}/img/globalping/github.svg">
			</div>

			<div class="gp_gh-links_content">
				<a target="_blank" rel="noopener noreferrer" href="https://github.com/jsdelivr/globalping" class="gp_gh-links_content_item">
					<span class="gp_gh-links_content_item_title">
						Globalping API
					</span>

					<span class="gp_gh-links_content_item_descr">
						Learn more about the project, the API, tools and become a contributor
					</span>
				</a>

				<a target="_blank" rel="noopener noreferrer" href="https://github.com/jsdelivr/globalping-cli" class="gp_gh-links_content_item">
					<span class="gp_gh-links_content_item_title">
						Globalping CLI
					</span>

					<span class="gp_gh-links_content_item_descr">
						Our simple to use CLI is also open source and awaits for your feedback.
					</span>
				</a>

				<a target="_blank" rel="noopener noreferrer" href="https://github.com/jsdelivr/globalping-probe" class="gp_gh-links_content_item">
					<span class="gp_gh-links_content_item_title">
						Globalping Probe
					</span>

					<span class="gp_gh-links_content_item_descr">
						Explore the codebase of our software probes and firmware for hardware probes as well
					</span>
				</a>
			</div>
		</div>

		<div class="gp_probe">
			<div class="gp_probe_promo">
				<img width="198"
					height="198"
					src="{{@shared.assetsHost}}/img/globalping/probe.png"
					srcset="{{@shared.assetsHost}}/img/globalping/probe@2x.png 2x">

				<div class="gp_probe_promo_content">
					<span class="gp_probe_promo_content_title">
						Get a hardware probe
					</span>

					<span class="gp_probe_promo_content_descr">
						Become a GitHub sponsor for $20/month or more and get your own hardware probe to install in your home or office network.
					</span>

					<a target="_blank" rel="noopener noreferrer" href="https://github.com/sponsors/jsdelivr" class="gp_probe_promo_content_btn gp_btn_green">
						<img width="20"
							height="20"
							src="{{@shared.assetsHost}}/img/globalping/github.small.svg">

						Become a GitHub Sponsor
					</a>
				</div>
			</div>

			<div class="gp_probe_get-probe">
				<div class="gp_probe_get-probe_header">
					How to get a probe?
				</div>

				<div class="gp_probe_get-probe_list">
					<div class="gp_probe_get-probe_list_item">
						<div class="gp_probe_get-probe_list_item_progress">
							<img width="24"
								height="24"
								src="{{@shared.assetsHost}}/img/globalping/circle-icon.svg">

							<span></span>
						</div>

						<div class="gp_probe_get-probe_list_item_content">
							<span>Become a sponsor</span>
							<span>Become a GitHub Sponsor for $20+/month.</span>
						</div>
					</div>

					<div class="gp_probe_get-probe_list_item">
						<div class="gp_probe_get-probe_list_item_progress">
							<img width="24"
								height="24"
								src="{{@shared.assetsHost}}/img/globalping/circle-icon.svg">

							<span></span>
						</div>

						<div class="gp_probe_get-probe_list_item_content">
							<span>Fill the form</span>
							<span>Fill out this form with your details.</span>
						</div>
					</div>

					<div class="gp_probe_get-probe_list_item">
						<div class="gp_probe_get-probe_list_item_progress">
							<img width="24"
								height="24"
								src="{{@shared.assetsHost}}/img/globalping/circle-icon.svg">
						</div>

						<div class="gp_probe_get-probe_list_item_content">
							<span class="green-text">Probe arrives</span>
							<span>Wait for the probe to arrive.</span>
						</div>
					</div>
				</div>
			</div>

			<div class="gp_probe_how-it-works">
				<div class="gp_probe_how-it-works_header">How it works?</div>
				<div class="gp_probe_how-it-works_text">
					<span>
						Installing our hardware probe simplifies the whole process and <b>removes the need of having a computer running 24/7.</b>
						Just connect the probe to your switch or router via an ethernet cable and you are done!
					</span>
					<span>
						Our hardware probes are fully secure. <b>They don't allow any kind of access to your LAN</b>, they block all malicious and abusive endpoints,
						don't open any ports whatsoever and the firmware itself is fully open source.
					</span>
				</div>

				<div class="gp_probe_how-it-works_btns">
					<a target="_blank"
						rel="noopener noreferrer"
						href="https://github.com/jsdelivr/globalping-hwprobe"
						class="gp_probe_how-it-works_btns_learn-more gp_btn_black">
						Learn more
					</a>

					<a target="_blank"
						rel="noopener noreferrer"
						href="https://github.com/sponsors/jsdelivr"
						class="gp_probe_how-it-works_btns_sponsor gp_btn_green">
						<img width="20"
							height="20"
							src="{{@shared.assetsHost}}/img/globalping/github.small.svg">

						Become a GitHub Sponsor
					</a>
				</div>
			</div>
		</div>

		<div class="gp_sponsors">
			<span class="gp_sponsors_title">Globalping sponsors</span>

			<span class="gp_sponsors_descr">
				We thank everyone who decided to help our project by either running multiple globally distributed probes or donating to our cause.
			</span>

			<div class="gp_sponsors_list">
				<div class="gp_sponsors_list_tier-one">
					<div class="gp_sponsors_list_tier-one_row">
						<a target="_blank" rel="noopener noreferrer" href="https://gcore.com">
							<img title="Sponsored by GCore"
								width="120"
								height="34"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/gcore.svg">
						</a>
						<a target="_blank" rel="noopener noreferrer" href="https://xtom.com">
							<img title="Sponsored by xTom"
								width="101"
								height="28"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/xtom.svg">
						</a>
					</div>

					<div class="gp_sponsors_list_tier-one_row">
						<a target="_blank" rel="noopener noreferrer" href="https://dedipath.com">
							<img title="Sponsored by DediPath"
								width="151"
								height="34"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/dedipath.png">
						</a>
						<a target="_blank" rel="noopener noreferrer" href="https://looking.house">
							<img title="Sponsored by Looking.house"
								width="151"
								height="34"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/looking-house.svg">
						</a>
					</div>

					<div class="gp_sponsors_list_tier-one_row">
						<a target="_blank" rel="noopener noreferrer" href="https://www.exoscale.com">
							<img title="Sponsored by Exoscale"
								width="210"
								height="28"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/exoscale.svg">
						</a>
						<a target="_blank" rel="noopener noreferrer" href="https://terrahost.com">
							<img title="Sponsored by Terrahost"
								width="139"
								height="28"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/terrahost.png">
						</a>
					</div>

					<div class="gp_sponsors_list_tier-one_row">
						<a target="_blank" rel="noopener noreferrer" href="https://www.fdcservers.net">
							<img title="Sponsored by FDCServers"
								width="95"
								height="28"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/fdc.svg">
						</a>
						<a target="_blank" rel="noopener noreferrer" href="https://www.starrydns.com">
							<img title="Sponsored by StarryDNS"
								width="160"
								height="28"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/starry.png">
						</a>
					</div>

					<div class="gp_sponsors_list_tier-one_row">
						<a target="_blank" rel="noopener noreferrer" href="https://zappiehost.com">
							<img title="Sponsored by Zappie Host"
								width="97"
								height="28"
								src="{{@shared.assetsHost}}/img/globalping/sponsors/zappiehost.png">
						</a>
					</div>
				</div>

<!--				<div class="gp_sponsors_list_tier-two">-->
<!--					<div class="gp_sponsors_list_tier-two_row">-->
<!--						<div class="gp_person-sponsor">Robert  Kowalski</div>-->

<!--						<img width="57"-->
<!--							height="19"-->
<!--							src="{{@shared.assetsHost}}/img/globalping/sponsors/dell.svg">-->

<!--						<div class="gp_person-sponsor">Magdalene Tabhita</div>-->
<!--					</div>-->
<!--				</div>-->
			</div>

			<a href="mailto:dak@prospectone.io" class="gp_sponsors_btn gp_btn_green">
				Get in Contact
			</a>
		</div>
	</div>

	<c-footer></c-footer>
</r-page>

<script>
	const _ = require('../../assets/js/_.js');
	const clipboard = require('../../assets/js/decorators/clipboard');
	const http = require('../../assets/js/utils/http');
	const validateDomainName = require('../../assets/js/utils/validate-domain-name');
	const validateIP = require('../../assets/js/utils/validate-ip');
	const validateByPattern = require('../../assets/js/utils/validate-by-pattern');
	const DEFAULT_PING_OPTS = {
		additionalOptsTotal: 1,
	};
	const DEFAULT_TRACEROUTE_OPTS = {
		protocol: 'ICMP',
		additionalOptsTotal: 2,
	};
	const DEFAULT_DNS_OPTS = {
		protocol: 'UDP',
		query: {
			type: 'A',
		},
		trace: true,
		additionalOptsTotal: 5,
	};
	const DEFAULT_MTR_OPTS = {
		protocol: 'ICMP',
		additionalOptsTotal: 3,
	};
	const DEFAULT_HTTP_OPTS = {
		protocol: 'HTTP',
		request: {
			method: 'GET',
		},
		additionalOptsTotal: 7,
	};
	const DEFAULT_PACKETS_AMOUNT = 3;
	const DEFAULT_LIMIT = 1;
	const VALIDATION_PATTERNS_MAP = {
		limit: [
			{
				pattern: '^[0-9]+$',
				errMsg: 'Limit must be an integer number',
			},
		],
		location: [
			{
				pattern: '^([a-zA-Z]{2}){1}(\\+[a-zA-Z]{2})*$',
				errMsg: 'Location must be in a valid format',
			},
		],
		packets: [
			{
				pattern: '^[0-9]+$',
				errMsg: 'Packets must be an integer number',
			},
		],
		port: [
			{
				pattern: '^[0-9]+$',
				errMsg: 'Port must be an integer number',
			},
		],
	};
	const MAPBOX_ACCESS_TOKEN = 'pk.eyJ1IjoiamltYWVrIiwiYSI6ImNrZzZ2b29weDAxZXYycW40YmRvZTY3aWkifQ.osESkOA-XJ11sphOFzJiHA';

	component.exports = {
		decorators: {
			clipboard,
		},
		data () {
			return {
				_,
				title: 'Globalping - Internet and web infrastructure monitoring and benchmarking ',
				description: 'Run free latency tests and network commands like ping, traceroute, HTTP and DNS resolve on probes located worldwide',
				testTypesList: [ 'ping', 'traceroute', 'DNS', 'MTR', 'HTTP' ],
				mainOptions: {
					type: 'ping',
					target: '',
					location: '',
					limit: '',
					additionalOptsTotal: DEFAULT_PING_OPTS.additionalOptsTotal,
				},
				showMap: true,
				showMeasurementOpts: false,
				dnsTypesList: [ 'A', 'AAAA', 'ANY', 'CNAME', 'DNSKEY', 'DS', 'MX', 'NS', 'NSEC', 'PTR', 'RRSIG', 'SOA', 'TXT', 'SRV' ],
				netDockerCmdText: 'docker run -d --log-driver local --network host --restart=always --name globalping-probe ghcr.io/jsdelivr/globalping-probe',
				totalProbes: 0,
				totalCities: 0,
				totalCountries: 0,
				pingOpts: DEFAULT_PING_OPTS,
				tracerouteOpts: DEFAULT_TRACEROUTE_OPTS,
				dnsOpts: DEFAULT_DNS_OPTS,
				mtrOpts: DEFAULT_MTR_OPTS,
				httpOpts: DEFAULT_HTTP_OPTS,
				inputErrors: {},
				testResults: null,
				testFailed: false,
				testInProgress: false,
				testReqInterval: null,
				notAppliedOpts: {},
				defaultPacketsAmount: DEFAULT_PACKETS_AMOUNT,
				defaultLimit: DEFAULT_LIMIT,
				probesMinMaxTimings: null,
			};
		},
		onrender () {
			if (!Ractive.isServer) {
				this.setupGpMap();
			}
		},
		oninit () {
			if (!Ractive.isServer) {
				http.fetchGlobalpingProbes().then((response) => {
					let { totalCities, totalCountries } = response.reduce((res, item) => {
						if (!res.citiesList.includes(item.location.city)) {
							res.citiesList.push(item.location.city);
						}

						if (!res.countriesList.includes(item.location.country)) {
							res.countriesList.push(item.location.country);
						}

						res.totalCities = res.citiesList.length;
						res.totalCountries = res.countriesList.length;

						return res;
					}, { citiesList: [], countriesList: [], totalCities: 0, totalCountries: 0 });

					this.animate('totalProbes', response.length, { duration: 2000 });
					this.animate('totalCities', totalCities, { duration: 2000 });
					this.animate('totalCountries', totalCountries, { duration: 2000 });
				});

				this.observe('mainOptions.type', (type) => {
					this.set('showMeasurementOpts', false);
					this.set('inputErrors', {});
					this.set('pingOpts', DEFAULT_PING_OPTS);
					this.set('tracerouteOpts', DEFAULT_TRACEROUTE_OPTS);
					this.set('dnsOpts', DEFAULT_DNS_OPTS);
					this.set('mtrOpts', DEFAULT_MTR_OPTS);
					this.set('httpOpts', DEFAULT_HTTP_OPTS);
					this.set('notAppliedOpts', {});
					this.set('testResults', null);
					this.set('probesMinMaxTimings', null);
					this.set('mainOptions.additionalOptsTotal', this.get(`${type.toLowerCase()}Opts`).additionalOptsTotal);
				}, { init: false });

				this.observe('testResults', (testResults) => {
					if (!testResults) { return; }

					let dnsOpts = this.get('dnsOpts');
					let testType = this.get('mainOptions.type');
					// collect all probes timings to create a scale
					let allProbesTimings = [];

					// create Markers geojson as source for the Map
					let markersSource = {
						type: 'geojson',
						cluster: true,
						clusterMaxZoom: 14,
						clusterRadius: 50,
						data: {
							type: 'FeatureCollection',
							features: [],
						},
					};

					markersSource.data.features = testResults.results.map((res) => {
						let probeTiming = _.calculateGpProbeTiming(testType, res, dnsOpts.trace);

						if (typeof probeTiming.value === 'number') {
							allProbesTimings.push(Math.round(probeTiming.value));
						}

						return {
							type: 'Feature',
							properties: {
								network: res.probe.network,
								city: res.probe.city,
								country: res.probe.country,
								timing: `${Math.round(probeTiming.value)}${probeTiming.units}`,
							},
							geometry: {
								type: 'Point',
								coordinates: [
									res.probe.longitude,
									res.probe.latitude,
								],
							},
						};
					});

					if (allProbesTimings.length) {
						this.set('probesMinMaxTimings', {
							max: Math.max(...allProbesTimings),
							min: Math.min(...allProbesTimings),
						});
					}


					this.set('markersSource', markersSource);
				}, { init: false });

				this.observe('markersSource', (markersSource) => {
					if (!markersSource) { return; }

					let mapInstance = this.get('mapInstance');

					mapInstance.addSource('probesList', markersSource);

					mapInstance.addLayer({
						id: 'clusters',
						type: 'circle',
						source: 'probesList',
						filter: [ 'has', 'point_count' ],
						paint: {
							'circle-color': [
								'step',
								[ 'get', 'point_count' ],
								'#51bbd6',
								100,
								'#f1f075',
								750,
								'#f28cb1',
							],
							'circle-radius': [
								'step',
								[ 'get', 'point_count' ],
								20,
								100,
								30,
								750,
								40,
							],
						},
					});

					mapInstance.addLayer({
						id: 'cluster-count',
						type: 'symbol',
						source: 'probesList',
						filter: [ 'has', 'point_count' ],
						layout: {
							'text-field': [ 'get', 'point_count_abbreviated' ],
							// 'text-font': [ 'Lexend' ], // TODO: no such font in the mapbox fonts list, how could we add em?
							'text-size': 16,
							// 'text-color': '#ffffff',// TODO: for some reason it cause an error
							'text-line-height': 24,
						},
					});

					mapInstance.addLayer({
						id: 'unclustered-point',
						type: 'circle',
						source: 'probesList',
						filter: [ '!', [ 'has', 'point_count' ] ],
						paint: {
							'circle-color': '#11b4da',
							'circle-radius': 4,
							'circle-stroke-width': 1,
							'circle-stroke-color': '#fff',
						},
					});

					mapInstance.on('click', 'clusters', (e) => {
						let features = mapInstance.queryRenderedFeatures(e.point, {
							layers: [ 'clusters' ],
						});
						let clusterId = features[0].properties.cluster_id;

						mapInstance.getSource('probesList').getClusterExpansionZoom(
							clusterId,
							(err, zoom) => {
								if (err) { return; }

								mapInstance.easeTo({
									center: features[0].geometry.coordinates,
									zoom,
								});
							},
						);
					});

					mapInstance.on('click', 'unclustered-point', (e) => {
						let coordinates = e.features[0].geometry.coordinates.slice();
						let { network, city, country, timing } = e.features[0].properties;

						while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
							coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
						}

						// eslint-disable-next-line no-undef
						new mapboxgl.Popup({ className: 'gp_mapbox_popup', closeButton: false, maxWidth: 'none', offset: 10 })
							.setLngLat(coordinates)
							.setHTML(`<div class='gp_mapbox_popup_timing'>${timing}</div>`
								+ `<div class='gp_mapbox_popup_info'>${network} (${city}, ${country})</div>`
								+ `<div class='gp_mapbox_popup_see-results'>See results</div>`)
							.addTo(mapInstance);
					});

					mapInstance.on('mouseenter', 'clusters', () => {
						mapInstance.getCanvas().style.cursor = 'pointer';
					});

					mapInstance.on('mouseleave', 'clusters', () => {
						mapInstance.getCanvas().style.cursor = '';
					});
				}, { init: false });
			}
		},
		proceedToTest () {
			let { type, target, location, limit } = this.get('mainOptions');
			let measurementOpts = this.get(`${type.toLowerCase()}Opts`);

			delete measurementOpts.additionalOptsTotal;

			let reqParams = { type };

			if (target) {
				reqParams.target = target;
			}

			if (!location) {
				reqParams.limit = limit || DEFAULT_LIMIT;
			} else {
				reqParams.locations = location.split('+').map(loc => ({
					magic: loc,
					limit: limit || DEFAULT_LIMIT,
				}));
			}

			// since packets field default value is present only for Ping and MTR type
			if (type.toLowerCase() === 'ping' || type.toLowerCase() === 'mtr') {
				reqParams.measurementOptions = {
					// set default values in case if user did not set them manually
					packets: DEFAULT_PACKETS_AMOUNT,
				};
			} else {
				delete measurementOpts.packets;
			}

			if (Object.keys(measurementOpts).length) {
				reqParams.measurementOptions = {
					...reqParams.measurementOptions,
					...measurementOpts,
				};
			}

			// get test interval and clear it when new test is started
			let testReqInterval = this.get('testReqInterval');

			if (testReqInterval) {
				clearInterval(testReqInterval);
			}

			// validate fields
			let inputErrors = this.validateDataForRequest(target, location, limit, measurementOpts);

			if (Object.keys(inputErrors).length) {
				this.set('inputErrors', inputErrors);

				return;
			}

			this.set('testResults', null);

			// if we have a source then we have already made a request and must clear the Map data before new request
			if (this.get('markersSource')) {
				this.set('markersSource', null);

				let mapInstance = this.get('mapInstance');

				mapInstance.removeLayer('clusters');
				mapInstance.removeLayer('cluster-count');
				mapInstance.removeLayer('unclustered-point');
				mapInstance.removeSource('probesList');
			}

			this.set('probesMinMaxTimings', null);
			this.set('testInProgress', true);

			// set dnsTraceEnabled value to know what it was during the request to avoid not necessary recalcs in gp-test-results
			this.set('dnsTraceEnabled', reqParams.measurementOptions.trace || false);

			http.postGlobalpingMeasurement(reqParams).then((response) => {
				testReqInterval = setInterval(() => {
					http.getGlobalpingMeasurement(response.id).then((testRes) => {
						if (testRes.status !== 'in-progress') {
							clearInterval(testReqInterval);

							this.set('testInProgress', false);
							this.set('testResults', testRes);
						}
					}).catch(() => {
						clearInterval(testReqInterval);
					});
				}, 1000);

				this.set('testReqInterval', testReqInterval);
			}).catch((err) => {
				if (err.error.type === 'validation_error') {
					this.set('testInProgress', false);
					let inputErrors = Object.keys(err.error.params).reduce((res, key) => {
						let fieldName = key.split('.')[key.split('.').length - 1];
						let errMsg = err.error.params[key].replace(/".*"/, fieldName);

						res[key] = errMsg;

						return res;
					}, {});

					this.set('inputErrors', inputErrors);
				}
			});
		},
		applyOptions () {
			let notAppliedOpts = this.get('notAppliedOpts');
			let { type } = this.get('mainOptions');
			let currOptsName = `${type.toLowerCase()}Opts`;
			let opts = this.get(currOptsName);

			switch (type.toLowerCase()) {
				case 'ping':
					opts.packets = notAppliedOpts.packets;
					break;

				case 'traceroute':
					opts.port = notAppliedOpts.port;
					break;

				case 'dns':
					opts.port = notAppliedOpts.port;
					opts.resolver = notAppliedOpts.resolver;
					break;

				case 'mtr':
					opts.port = notAppliedOpts.port;
					opts.packets = notAppliedOpts.packets;
					break;

				case 'http':
					opts.port = notAppliedOpts.port;
					opts.resolver = notAppliedOpts.resolver;
					opts.request.host = notAppliedOpts.host;
					opts.request.path = notAppliedOpts.path;
					opts.request.query = notAppliedOpts.query;
					break;
			}

			// filter opts from empty values
			let filteredOpts = Object.keys(opts).reduce((res, key) => {
				if (typeof opts[key] === 'object') {
					res[key] = Object.keys(opts[key]).reduce((secRes, secKey) => {
						if (opts[key][secKey] !== '') {
							secRes[secKey] = opts[key][secKey];
						}

						return secRes;
					}, {});
				} else if (opts[key] !== '') {
					res[key] = opts[key];
				}

				return res;
			}, {});

			this.set(currOptsName, filteredOpts);
			this.set('showMeasurementOpts', false);
		},
		validateDataForRequest (target, location, limit, measurementOpts) {
			let inputErrors = {};

			// validate Target field
			if (!target) {
				inputErrors.target = 'Target is required';
			} else {
				let isValidDomainName = validateDomainName.test(target);
				let isValidIP = validateIP.test(target);

				if (!isValidDomainName && !isValidIP) {
					inputErrors.target = 'Target does not match any of the allowed formats';
				}
			}

			// validate Location field
			if (location) {
				let result = VALIDATION_PATTERNS_MAP.location.reduce((res, data) => {
					let isValid = validateByPattern.test(location, data.pattern);

					if (res.isValid && !isValid) {
						return {
							isValid: false,
							errMsg: data.errMsg,
						};
					}

					return res;
				}, { isValid: true, errMsg: '' });

				if (!result.isValid) {
					inputErrors.location = result.errMsg;
				}
			}

			// validate Limit field
			if (limit) {
				let result = VALIDATION_PATTERNS_MAP.limit.reduce((res, data) => {
					let isValid = validateByPattern.test(Math.abs(limit), data.pattern);

					if (res.isValid && !isValid) {
						return {
							isValid: false,
							errMsg: data.errMsg,
						};
					}

					return res;
				}, { isValid: true, errMsg: '' });

				if (!result.isValid) {
					inputErrors.limit = result.errMsg;
				} else if (limit > 500 || limit < 1) {
					inputErrors.limit = 'Limit must be from 1 to 500 inclusive';
				}
			}

			// validate Measurement Options
			if (measurementOpts.packets) {
				let result = VALIDATION_PATTERNS_MAP.packets.reduce((res, data) => {
					let isValid = validateByPattern.test(Math.abs(measurementOpts.packets), data.pattern);

					if (res.isValid && !isValid) {
						return {
							isValid: false,
							errMsg: data.errMsg,
						};
					}

					return res;
				}, { isValid: true, errMsg: '' });

				if (!result.isValid) {
					inputErrors['measurementOptions.packets'] = result.errMsg;
				} else if (measurementOpts.packets > 16 || measurementOpts.packets < 1) {
					inputErrors['measurementOptions.packets'] = 'Packets must be from 1 to 16 inclusive';
				}
			}

			if (measurementOpts.port) {
				let result = VALIDATION_PATTERNS_MAP.port.reduce((res, data) => {
					let isValid = validateByPattern.test(Math.abs(measurementOpts.port), data.pattern);

					if (res.isValid && !isValid) {
						return {
							isValid: false,
							errMsg: data.errMsg,
						};
					}

					return res;
				}, { isValid: true, errMsg: '' });

				if (!result.isValid) {
					inputErrors['measurementOptions.port'] = result.errMsg;
				} else if (measurementOpts.port > 65535 || measurementOpts.port < 1) {
					inputErrors['measurementOptions.port'] = 'Port must be from 1 to 65535 inclusive';
				}
			}

			if (measurementOpts.resolver) {
				let isValidIP = validateIP.test(measurementOpts.resolver);

				if (!isValidIP) {
					inputErrors['measurementOptions.resolver'] = 'Resolver must be a valid ip address of one of the following versions [ipv4] with a forbidden CIDR';
				}
			}

			if (measurementOpts?.request?.host) {
				let isValidDomainName = validateDomainName.test(measurementOpts.request.host);

				if (!isValidDomainName) {
					inputErrors['measurementOptions.request.host'] = 'Host must contain a valid domain name';
				}
			}

			return inputErrors;
		},
		setupGpMap () {
			// eslint-disable-next-line no-undef
			let map = new mapboxgl.Map({
				accessToken: MAPBOX_ACCESS_TOKEN,
				container: 'gp-map',
				style: 'mapbox://styles/jimaek/clg7spzm7009l01mmsgaifc92',
				center: [ 0, 0 ],
				zoom: -1,
				cooperativeGestures: true,
				attributionControl: false,
			});

			map.addControl(
			// eslint-disable-next-line no-undef
				new mapboxgl.NavigationControl({
					showCompass: false,
				}),
				'bottom-right',
			);

			this.set('mapInstance', map);
		},
	};
</script>
