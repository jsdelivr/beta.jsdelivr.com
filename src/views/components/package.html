<link rel="ractive" href="./collection-box.html" name="c-collection-box">
<link rel="ractive" href="./package-file-browser.html" name="c-package-file-browser">
<link rel="ractive" href="./package-header.html" name="c-package-header">
<link rel="ractive" href="./top-stats-table.html" name="c-top-stats-table">
<link rel="ractive" href="./version-dropdown.html" name="c-version-dropdown">

<div class="c-package">
	<div class="container">
		{{#if versions}}
			<div class="row">
				<div class="main-content">
					<c-package-header
						package="{{package}}"
						type="{{type}}"
						name="{{name}}"
						version="{{version}}"
						packageVersionsNotFound="{{packageVersionsNotFound}}"
						navRoute="{{navRoute}}">
					</c-package-header>

					<div class="package-nav">
						<a on-click="@this.set('navRoute', 'readme')" class="package-nav-route {{navRoute === 'readme' ? 'package-nav-route-active' : ''}}">
							<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/book.svg"><span>Readme</span>
						</a>
						<a on-click="@this.set('navRoute', 'config')" class="package-nav-route {{navRoute === 'config' ? 'package-nav-route-active' : ''}}">
							<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/settings.svg"><span>Show/Configure Files</span>
						</a>
						<a on-click="@this.set('navRoute', 'stats')" class="package-nav-route {{navRoute === 'stats' ? 'package-nav-route-active' : ''}}">
							<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/statistics.svg"><span>Statistics</span>
						</a>
						<a target="_blank" rel="nofollow noopener" href="https://cdn.jsdelivr.net/npm/{{name}}/" class="package-nav-route">
							<span>Browse CDN Files</span><img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/external-link.svg">
						</a>
					</div>

					{{#if navRoute === 'readme'}}
						<div class="package-readme">
							<div class="header-primary mb-8">{{name}}</div>
							<div class="description mb-32">
								jQuery is a fast, small, and feature-rich JavaScript library.
								<br />
								<br />
								For information on how to get started and how to use {{name}}, please see <a href="/" class="package-link">{{name}}'s documentation</a>.
								For source files and issues, please visit the <a href="/" class="package-link">{{name}} repo</a>.
								<br />
								<br />
								If upgrading, please see the <a href="/" class="package-link">blog post for {{version}}</a>. This includes notable differences from the previous version and a more readable changelog.
							</div>

							<div class="header-secondary mb-8">Including {{name}}</div>
							<div class="text-primary mb-32">Below are some of the most common ways to include {{name}}.</div>

							<div class="header-tertiary mb-32">Keywords</div>

							<div class="script-card mb-32">
								<div class="text-secondary">Script tag</div>
								<div class="script-block mt-16">
									&#60;script src="https://code.jquery.com/jquery-3.6.0.min.js"&#62;&#60;/script&#62;
								</div>
							</div>

							<div class="script-card mb-32">
								<div class="text-secondary mb-8">Babel</div>
								<div class="text-primary">
									<a target="_blank" href="https://babeljs.io/" class="package-link" rel="noopener">Babel</a> is a next generation JavaScript compiler. One of the features is the ability to use ES6/ES2015 modules now,
									even though browsers do not yet support this feature natively.
								</div>
								<div class="script-block mt-16">
									<span class="text-js-keywords">import</span> $ <span class="text-js-keywords">from</span> <span class="text-js-string">"{{name}}"</span>;
								</div>
							</div>

							<div class="script-card">
								<div class="text-secondary mb-8">Browserify/Webpack</div>
								<div class="text-primary">
									There are several ways to use Browserify and Webpack. For more information on using these tools, please refer to
									the corresponding project's documentation. In the script, including jQuery will usually look like this...
								</div>
								<div class="script-block mt-16">
									<span class="text-js-keywords">var</span> $ = <span class="text-js-func">require</span>( <span class="text-js-string">"{{name}}"</span> );
								</div>
							</div>
						</div>
					{{/if}}
				</div>

				<div class="side-content">
					<div class="package-stats {{navRoute === 'stats' ? 'move-top' : ''}}">
						<div class="block-shadow {{navRoute === 'config' ? 'bottom' : navRoute === 'stats' ? 'top' : ''}}"></div>
						{{#if navRoute !== "stats"}}
							<div class="stats-title">
								<span class="text-secondary">Statistics</span>

								<div class="btn-group">
									<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
										<span>{{~/statsPeriods[statsPeriod]}}</span>
										<i class="fa fa-angle-down" aria-hidden="true"></i>
									</button>

									<ul class="dropdown-menu">
										{{#each ~/statsPeriods}}
											<li><a on-click="@this.set('statsPeriod', @key)">{{this}}</a></li>
										{{/each}}
									</ul>
								</div>
							</div>

							<div class="horizontal-divider mt-24 mb-24"></div>

							<div class="stats-title mb-24">
								<span>Requests Served</span>
								<span class="text-secondary">{{_.formatNumber(versionStatsData.total)}}</span>
							</div>

							<div class="stats-chart"></div>

							<div class="horizontal-divider mt-24 mb-24"></div>

							<div class="stats-title mb-24">
								<span>Bandwidth</span>
								<span class="text-secondary">52.5 GB</span>
							</div>

							<div class="stats-chart"></div>

							<div class="horizontal-divider mt-24 mb-24"></div>
						{{/if}}

						<div class="stats-title mb-24">
							<span>Top version - {{versionStats[0].version}}</span>
							<span class="text-secondary">{{_.formatNumber(versionStats[0].hits)}}</span>
						</div>

						{{#if navRoute !== "config"}}
							<a target="_blank" href="/" rel="noopener" class="btn-full-stats">Full {{name}} Download Stats</a>

							<div class="horizontal-divider mt-24 mb-24"></div>

							<div class="twitter-share">
								<div>{{_.nth(versionStatsData.rank + 1)}} most popular on jsDelivr</div>
								<a class="btn-twitter-share mt-8" target="_blank" rel="noopener" href="https://twitter.com/intent/tweet?text={{encodeURIComponent(`${name} is the ${_.nth(versionStatsData.rank + 1)} most popular package on @jsDelivr CDN, with ${_.formatNumber(versionStatsData.total)} hits in the last ${~/statsPeriods[~/statsPeriod]}: ${~/link}`)}}">
									<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/twitter-white.svg">
									Share
								</a>
							</div>

							{{#if package.keywords}}
								<div class="stats-keywords mt-32">
									<div class="stats-keywords-header text-secondary">Keywords</div>
									<div class="stats-keywords-badges">
										{{#each package.keywords}}
											<div class="keyword-badge">{{this}}</div>
										{{/each}}
									</div>
								</div>
							{{/if}}
						{{/if}}
					</div>

					{{#if navRoute !== "config"}}
						<div class="box-badge mt-32">
							<div class="box-title text-secondary">Get a badge for your package</div>
							<img width="140" height="20" src="https://data.jsdelivr.com/v1/package/{{~/type || 'npm'}}/{{name}}/badge{{#if ~/badgeAltStyle}}?style=rounded{{/if}}">
							<img as-clipboard="'Copy markdown to clipboard', 'bottom'" data-clipboard-text="[![](https://data.jsdelivr.com/v1/package/{{~/type}}/{{~/name}}/badge{{#if ~/badgeAltStyle}}?style=rounded{{/if}})](https://www.jsdelivr.com/package/{{~/type}}/{{~/name}})" width="20" height="20" src="{{@shared.assetsHost}}/img/icons/copy-btn-black.svg">
							<img as-tooltip="'Alternate badge style', 'bottom'" on-click="@this.toggle('badgeAltStyle')" width="20" height="20" src="{{@shared.assetsHost}}/img/icons/alternate-btn.svg">
						</div>
					{{/if}}
				</div>

				{{#if navRoute === 'config'}}
					<div class="package-config full-width-content">
						<c-package-file-browser
							type="{{type}}"
							name="{{name}}"
							github="{{package.githubRepo}}"
							version="{{version}}"
							versions="{{versions}}"
							path="{{path}}"
							collection="{{collection}}"
							files="{{~/files}}">
						</c-package-file-browser>

						<c-collection-box collection="{{collection}}"></c-collection-box>
					</div>
				{{elseif navRoute === 'stats'}}
					<div class="package-statistics full-width-content">
						<div class="header">
							<div class="header-title">Statistics</div>
							<div class="header-ctrls">
								<div class="chart-type-ctrl">
									<span>Show numers of</span>

									<input id="chart-switch"
										type="checkbox"
										class="chart-type-switch"
										checked="{{~/showBandwidth}}"
										twoway="false">

									<label for="chart-switch" on-click="@this.set('showBandwidth', true)">
										<span>Request</span>
										<span>GB</span>
									</label>
								</div>

								<div class="data-range-ctrl">
									<span>Data range:</span>

									<div class="btn-group">
										<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
											<span>{{~/statsPeriods[statsPeriod]}}</span>
											<i class="fa fa-angle-down" aria-hidden="true"></i>
										</button>

										<ul class="dropdown-menu">
											{{#each ~/statsPeriods}}
												<li><a on-click="@this.set('statsPeriod', @key)">{{this}}</a></li>
											{{/each}}
										</ul>
									</div>
								</div>
							</div>
						</div>
						<div class="stats-cards">
							<div>
								<div class="card-icon">
									<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/request.svg">
								</div>
								<div class="card-main-stat">
									<span>406 745 962</span>
									<span>Requests Served</span>
								</div>
								<div class="card-growth">
									<span class="growth-positive">+34%</span>
									<span>monthly growth</span>
								</div>
							</div>

							<div>
								<div class="card-icon">
									<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/transfer.svg">
								</div>
								<div class="card-main-stat">
									<span>648 414</span>
									<span>Bandwidth</span>
								</div>
								<div class="card-growth">
									<span class="growth-negative">-9%</span>
									<span>monthly growth</span>
								</div>
							</div>
						</div>

						<div class="chart-stats">
							{{#if totalStats.total}}
								<div class="package-usage">
									<div class="small-headline">Stats for last month</div>

									<div class="group-by-ctrl">
										<span>
											Group by:
										</span>

										<div class="btn-group">
											<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
												<span>{{~/statsPeriods[statsPeriod]}}</span>
												<i class="fa fa-angle-down" aria-hidden="true"></i>
											</button>

											<ul class="dropdown-menu">
												{{#each ~/statsPeriods}}
													<li><a on-click="@this.set('statsPeriod', @key)">{{this}}</a></li>
												{{/each}}
											</ul>
										</div>
									</div>
								</div>

								<div class="bottom-chart">
									<!-- {{#if (~/bottomChartLabels.length - 2) / chartXInterval > 3 && ~/bottomChartData}}
										<div class="chart-x">
											{{#each ~/bottomChartLabels}}
												{{#if (@key + 1) % ~/chartXInterval === 1 % ~/chartXInterval && @key !== 0 && @key !== Math.floor((~/bottomChartData.length - 1) / ~/chartXInterval) * ~/chartXInterval}}
													<div style="left: calc({{(100 / (~/bottomChartLabels.length - 1)) * (@key)}}% - 100px);">
														<div class="x-number">{{_.formatNumber(~/bottomChartData[@key])}}</div>
														<div class="x-date">{{this}}</div>
														<div class="x-line"></div>
													</div>
												{{/if}}
											{{/each}}
										</div>
									{{/if}}

									<div class="chart-y">
										{{#with _.linRange(totalStatsMax, 8).reverse() as range}}
											{{#each range}}
												<div style="height: {{290 / range.length + 7}}px;">{{_.formatNumber(this)}}</div>
											{{/each}}
										{{/with}}
									</div> -->

									<canvas id="stats-tab-chart" width="1224" height="290"></canvas>
								</div>
							{{else}}
								<div class="container">
									<section class="package-usage-empty"></section>
								</div>
							{{/if}}
						</div>

						<div class="horizontal-divider mt-40 mb-40"></div>

						<div class="chart-tops">
							{{#if ~/versionStats}}
								<c-top-stats-table title="Top 5 versions" data="{{~/versionStats.slice(0, 5)}}" type="{{~/type}}" name="{{~/name}}" version="{{~/fileStatsVersion}}">
									{{#partial column1}}
										<a on-click="@this.set('version', version)">{{version}}</a>
									{{/partial}}
								</c-top-stats-table>

								<c-top-stats-table data="{{~/fileStats.slice(0, 5)}}" type="{{~/type}}" name="{{~/name}}" version="{{~/fileStatsVersion}}" versions="{{versions}}">
									{{#partial header}}
										Top 5 files in v{{~/version}}
									{{/partial}}

									{{#partial column1}}
										<a title="{{file}}" target="_blank" href="https://cdn.jsdelivr.net/{{~/type}}/{{~/name}}@{{~/version}}{{file}}">{{file}}</a>
									{{/partial}}
								</c-top-stats-table>
							{{/if}}
						</div>

						<div class="horizontal-divider mt-40 mb-40"></div>

						<div class="chart-per-day" style="height: 397px;"></div>
					</div>
				{{/if}}
			</div>
		{{/if}}
	</div>
</div>

<script>
	const _ = require('../../public/js/_');
	const http = require('../../public/js/utils/http');
	const debounce = require('../../public/js/utils/debounce');
	const clipboard = require('../../public/js/decorators/clipboard');
	const tooltip = require('../../public/js/decorators/tooltip');

	component.exports = {
		computed: {
			chartXInterval () {
				this.get('_resizeId'); // Keep this here so that it updates on resize.
				return this.get('bottomChartLabels') ? Math.ceil(this.get('bottomChartLabels').length / Math.floor(innerWidth / 140)) : 1;
			},
			hasSourceMaps () {
				let files = this.get('files');
				let hasMin, hasMap;

				if (!files) {
					return true;
				}

				_.flattenFiles(files).forEach((file) => {
					if (/\.min\.(?:js|css)$/.test(file)) {
						hasMin = true;
					} else if (/\.map$/.test(file)) {
						hasMap = true;
					}
				});

				return !hasMin || hasMap;
			},
			issueSourceMaps () {
				return `https://github.com/${this.get('package.githubRepo.user')}/${this.get('package.githubRepo.project')}/issues/new/`
					+ `?title=No source maps for minified files`
					+ `&body=[This package](${this.get('@global.location.href')}) doesn't contain source maps for the minified files. It would be great to add them for easier debugging.`;
			},
		},
		data () {
			return {
				_,
				collection: [],
				statsPeriods: {
					1: 'day',
					7: 'week',
					30: 'month',
					365: 'year',
				},
				statsPeriod: 30,
				versions: [],
				link: location.href,
				_resizeId: 0,
				navRoute: 'readme',
				showBandwidth: false,
			};
		},
		decorators: {
			clipboard,
			tooltip,
		},
		oninit () {
			if (!Ractive.isServer) {
				let bottomChart;

				// Load package versions.
				http.fetchPackageVersions(this.get('type'), this.get('name')).then((data) => {
					this.set('versions', data.versions);

					// This can only happen for GitHub packages.
					if (data.versions.length === 0) {
						return this.set({ packageVersionsNotFound: true });
					}

					// Set version for GitHub packages.
					if (!this.get('package.version')) {
						this.set('package.version', data.versions[0]);
					}

					// Set version for GitHub packages or when an invalid version is selected.
					if (!this.get('version') || data.versions.indexOf(this.get('version')) === -1) {
						this.set('version', data.versions[0]);
					}
				}).catch((error) => {
					this.set({ packageNotFound: true });
					console.error(`Package versions not found.`, error);
				});

				this.observe('statsPeriod fileStatsVersion', () => {
					if (this.get('statsPeriod') && this.get('fileStatsVersion')) {
						let type = this.get('type');
						let name = this.get('name');
						let version = this.get('fileStatsVersion');
						let period = this.get('statsPeriods')[this.get('statsPeriod')];

						Pace.restart();

						http.fetchPackageFileStats(type, name, version, period).then((data) => {
							let array = [];

							Object.keys(data.files).forEach((key) => {
								array.push({
									file: key,
									hits: data.files[key].total,
								});
							});

							this.animate('fileStats', array.sort((a, b) => b.hits - a.hits));
						});
					}
				});

				this.observe('statsPeriod version navRoute', () => {
					if (this.get('statsPeriod') && this.get('version')) {
						let type = this.get('type');
						let name = this.get('name');
						let period = this.get('statsPeriods')[this.get('statsPeriod')];

						http.fetchPackageVersionStats(type, name, period).then((data) => {
							let array = [];

							Object.keys(data.versions).forEach((key) => {
								array.push({
									version: key,
									hits: data.versions[key].total,
								});
							});

							this.animate('versionStats', array.sort((a, b) => b.hits - a.hits));
							this.animate('versionStatsData', data);

							// Maybe we have no stats yet.
							if (array[0]) {
								this.set('fileStatsVersion', array[0].version);
							}
						});

						// Bottom chart.
						if (period !== 'day') {
							http.fetchPackageDateStats(type, name, period).then((response) => {
								let maxValue = Math.max(...Object.keys(response.dates).map(date => response.dates[date].total));
								let magnitude = Math.floor(Math.log10(maxValue));
								this.set('totalStatsMax', Math.ceil(maxValue / Math.pow(10, magnitude)) * Math.pow(10, magnitude));
								this.set('totalStats', response);

								if (!response.total) {
									return;
								}

								let array = [];

								Object.keys(response.dates).forEach((date) => {
									array.push([ date, response.dates[date] ]);
								});

								array.sort((a, b) => new Date(a[0]) - new Date(b[0]));

								if (bottomChart) {
									bottomChart.destroy();
									bottomChart = null;
								}

								let labels = array.map(value => _.formatDate(new Date(value[0])).toUpperCase());
								let data = array.map(value => value[1].total);

								this.set('bottomChartLabels', labels);
								this.set('bottomChartData', data);

								let chartEl = this.find('#stats-tab-chart');
								let chartBarContext = chartEl.getContext('2d');
								let barBackground = chartBarContext.createLinearGradient(0, 0, 0, 300);
								barBackground.addColorStop(0, 'rgb(246, 81, 40)');
								barBackground.addColorStop(1, 'rgba(246, 81, 40, 0.08)');

								bottomChart = new Chart(chartEl, {
									type: 'bar',
									data: {
										labels,
										datasets: [{
											data,
											backgroundColor: barBackground,
											borderWidth: 0,
											pointRadius: 0,
											barThickness: 10,
										}],
									},
									options: {
										plugins: {
											legend: {
												display: false,
											},
										},
										scales: {
											x: {
												grid: {
													display: false,
													drawBorder: false,
													borderColor: '#dadde2',
												},
											},
											y: {
												grid: {
													display: false,
													borderColor: '#dadde2',
												},
											},
										},
										// maintainAspectRatio: false,
										// fill: true,
										// legend: {
										// 	display: false,
										// },
										// scales: {
										// 	yAxes: [{
										// 		display: true,
										// 		ticks: {
										// 			min: 0,
										// 			max: this.get('totalStatsMax'),
										// 			beginAtZero: true,
										// 		},
										// 	}],
										// 	xAxes: [{
										// 		display: true,
										// 	}],
										// },
									},
								});
							});
						}
					}
				});

				if (!this.get('version')) {
					this.set('version', this.get('package.version'));
				}
			}
		},
		onrender () {
			let resize = debounce(() => {
				this.add('_resizeId');
			});

			this.on('unrender', () => $(window).off('resize', resize));
			$(window).on('resize', resize);
			resize();
		},
	};
</script>
