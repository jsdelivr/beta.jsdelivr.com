<div class="c-gp-test-results">
	<div class="c-gp-test-results_list">
		{{#each testResults.results:idx}}
			<div class="c-gp-test-results_list_item">
				<div class="c-gp-test-results_list_item_header">
					<span class="c-gp-test-results_list_item_header_info">
						<span>
							<img width="28"
								height="20"
								src="https://cdn.jsdelivr.net/npm/country-flag-icons@1.5.5/3x2/{{this.probe.country}}.svg">
								{{this.probe.city}}, {{this.probe.country}}, {{this.probe.continent}}
						</span>
						<span>&nbsp;-&nbsp;</span>
						<span>{{this.probe.network}} ({{this.probe.continent}}{{this.probe.asn}})</span>
					</span>

					<img class="c-gp-test-results_list_item_header_dot-icon"
						width="4"
						height="4"
						src="{{@shared.assetsHost}}/img/globalping/dot-icon.svg">

					{{#if testResultsTimings[idx]}}
						<span class="c-gp-test-results_list_item_header_time">
							<span>Time:</span>
							<span class="c-gp-test-results_list_item_header_time_value">{{testResultsTimings[idx]}}</span>
						</span>
					{{/if}}

					<img on-click="@this.hideShowTestResult(idx)"
						class="c-gp-test-results_list_item_header_dropdown-icon {{#if hiddenTestResults.includes(idx)}}upside-down{{/if}}"
						width="24"
						height="24"
						src="{{@shared.assetsHost}}/img/globalping/chevron-up-icon.svg">
				</div>

				<pre class="{{#if hiddenTestResults.includes(idx)}}hidden{{/if}}">{{this.result.rawOutput}}</pre>

				<div class="c-gp-test-results_list_item_status-line {{#if _.calcGpTestResTiming(testType, this, dnsTraceEnabled).isFailed}}failed{{/if}}"></div>
			</div>
		{{/each}}
	</div>

	<div class="c-gp-test-results_share">
		<span>Share your results:</span>

		<div>{{`http://www.jsdelivr.com/globalping?id=${testResults.id}`}}</div>

		<button as-clipboard data-clipboard-text="{{`http://www.jsdelivr.com/globalping?id=${testResults.id}`}}">
			<img width="20"
				height="20"
				src="{{@shared.assetsHost}}/img/globalping/copy-icon-black.svg">
		</button>
	</div>
</div>

<script>
	const _ = require('../../assets/js/_');
	const clipboard = require('../../assets/js/decorators/clipboard');

	component.exports = {
		decorators: {
			clipboard,
		},
		data () {
			return {
				_,
				hiddenTestResults: [],
				testResultsTimings: [],
			};
		},
		onrender () {
			if (!Ractive.isServer) {
				this.observe('testResults', (testResults) => {
					if (!testResults) { return; }

					// calculate timings for each test result
					// calculate additional timings info for each test result
					let testType = this.get('testType');
					let dnsTraceEnabled = this.get('dnsTraceEnabled');

					let timings = testResults.results.reduce((timingValues, result) => {
						timingValues.mainTimingValues.push(_.calcGpTestResTiming(testType, result, dnsTraceEnabled).fullText);

						return timingValues;
					}, {
						mainTimingValues: [],
					});

					this.set('testResultsTimings', timings.mainTimingValues);

					// calculate results block height
					this.setResultsBlockHeight(testResults);
				}, { defer: true });


				// open result under specific index when scrool to this element from the parent called
				this.observe('scrolledToResIdx', (scrolledToResIdx) => {
					if (scrolledToResIdx === null) { return; }

					let hiddenTestResults = this.get('hiddenTestResults');

					if (hiddenTestResults.includes(scrolledToResIdx)) {
						this.hideShowTestResult(scrolledToResIdx);
					}

					this.set('scrolledToResIdx', null);
				}, { init: false });
			}
		},
		hideShowTestResult (idx) {
			let hiddenTestResults = this.get('hiddenTestResults');

			if (hiddenTestResults.includes(idx)) {
				hiddenTestResults.splice(hiddenTestResults.indexOf(idx), 1);
			} else {
				hiddenTestResults.push(idx);
			}

			this.set('hiddenTestResults', hiddenTestResults);
		},
		setResultsBlockHeight (testResults) {
			requestAnimationFrame(() => {
				let listEl = document.querySelector('.c-gp-test-results_list');
				let itemsAmount = testResults.results.length;
				let lestElScrollHeight = listEl.scrollHeight;
				let avgItemElHeight = Math.round(lestElScrollHeight / itemsAmount);

				listEl.style.height = `${itemsAmount < 3 ? avgItemElHeight * itemsAmount : avgItemElHeight * 3}px`;
			});
		},
	};
</script>
