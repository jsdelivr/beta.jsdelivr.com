<div class="c-gp-credits {{#if mapOpened}}over-the-map{{/if}}">
	{{#if remainingRequests !== null && availableRequests !== null && resetsInStr !== null}}
		<div class="credits-wrapper">
			<div class="credits_data">
				<div class="credits_data_rate">
					<span class="credits_data_rate_header">Rate limit:</span>
					<span class="credits_data_rate_details">
						<img as-tooltip="'Resets in ' + resetsInStr"
							width="14"
							height="14"
							src="{{@shared.assetsHost}}/img/globalping/help-icon.svg">

						<span class="credits_data_rate_details_numbers">
							<span class="credits_data_rate_details_numbers_credits-count">
								{{remainingRequests}}/{{availableRequests}}
							</span>

							{{#if consumedRateLimit}}
								<span class="credits_data_rate_details_numbers_probes-count">
									(-{{consumedRateLimit}})
								</span>
							{{/if}}
						</span>
					</span>
				</div>

				{{#if creditsDataPresented}}
					<div class="credits_data_credits">
						<span class="credits_data_credits_header">
							Credits:
						</span>

						<span class="credits_data_rate_details">
							<span class="credits_data_rate_details_remaining-credits">
								{{remainingCredits}}
							</span>

							{{#if consumedCredits}}
								<span class="credits_data_rate_details_consumed-credits">
									(-{{consumedCredits}})
								</span>
							{{/if}}
						</span>
					</div>
				{{/if}}
			</div>

			<a href="/" class="credits_add">
				+ Add Credits
			</a>

			{{#if testInProgress && isInfiniteModeRes && consumingValue !== null}}
				<div class="credits_consuming">
					<img width="14"
						height="14"
						src="{{@shared.assetsHost}}/img/globalping/alert-icon-alt.svg">

					<span>Currently consuming ~{{consumingValue}} credits/minute</span>
				</div>
			{{/if}}
		</div>
	{{/if}}
</div>

<script>
	const tooltip = require('../../assets/js/decorators/tooltip');

	component.exports = {
		decorators: {
			tooltip,
		},
		data () {
			return {
				consumingValue: null,
				remainingRequests: null,
				availableRequests: null,
				consumedRateLimit: null,
				remainingCredits: null,
				consumedCredits: -16,
				resetsInStr: '',
				creditsDataPresented: false,
				overallProbesCount: 0,
				sessionTimestampStart: null,
				sessionTimestampCurrent: null,
			};
		},
		oninit () {
			if (!Ractive.isServer) {
				this.observe('rateCreditsData', (rateCreditsData) => {
					if (rateCreditsData) {
						let rateLimitRemaning = rateCreditsData['x-ratelimit-remaining'] || 0;
						let rateLimitLimit = rateCreditsData['x-ratelimit-limit'] || 0;
						let rateLimitReset = rateCreditsData['x-ratelimit-reset'] || 0;
						let currentProbesCount = rateCreditsData.probesCount || 0;
						let rateCreditsConsumed = rateCreditsData['x-credits-consumed'] || 0;
						let rateCreditsRemaning = rateCreditsData['x-credits-remaining'] || 0;

						// handle RateLimit headers
						this.set('remainingRequests', rateLimitRemaning);
						this.set('availableRequests', rateLimitLimit);
						this.set('resetsInStr', this.createResetInStr(rateLimitReset));
						this.set('overallProbesCount', this.get('overallProbesCount') + currentProbesCount);

						// handle Credits headers
						if (rateCreditsRemaning) {
							this.set('creditsDataPresented', true);
							this.set('consumedRateLimit', currentProbesCount - rateCreditsConsumed);
							this.set('consumedCredits', rateCreditsConsumed);
							this.set('remainingCredits', rateCreditsRemaning);
						} else {
							this.set('creditsDataPresented', false);
						}
					}
				});

				// set session start time when test is started
				this.observe('testInProgress', (testInProgress) => {
					if (testInProgress) {
						this.set('sessionTimestampStart', Date.now());
						this.set('sessionTimestampCurrent', Date.now());
					}
				});

				// update current timestamp on receiving testRResults
				this.observe('testResults', (testResults) => {
					if (testResults) {
						this.set('sessionTimestampCurrent', Date.now());
					}
				});

				// calculate consuming value
				this.observe('overallProbesCount sessionTimestampCurrent', () => {
					let sessionTimestampCurrent = this.get('sessionTimestampCurrent');
					let overallProbesCount = this.get('overallProbesCount');
					let sessionTimestampStart = this.get('sessionTimestampStart');
					let sessionTime = (sessionTimestampCurrent - sessionTimestampStart) / 1000;
					let consumingValuePerSecond = overallProbesCount / (sessionTime || 1);

					this.set('consumingValue', Math.round(consumingValuePerSecond * 60));
				}, { init: false });
			}
		},
		createResetInStr (seconds) {
			let minutes = seconds / 60;

			if (minutes < 1) {
				return '< 1 minute';
			}

			return `${Math.ceil(minutes)} minutes`;
		},
	};
</script>
