<div class="c-gp-credits {{#if mapOpened}}over-the-map{{/if}}">
	{{#if remainingRequests !== null && availableRequests !== null && resetsInStr !== null}}
		<div class="credits-wrapper">
			<div class="credits_data">
				<div class="credits_data_rate">
					<span class="credits_data_rate_header">Rate limit:</span>
					<span class="credits_data_rate_details">
						<img as-tooltip="'Resets in ' + resetsInStr"
							width="14"
							height="14"
							src="{{@shared.assetsHost}}/img/globalping/help-icon.svg">

						<span class="credits_data_rate_details_numbers">
							<span class="credits_data_rate_details_numbers_credits-count">
								{{remainingRequests}}/{{availableRequests}}
							</span>

							{{#if consumedRateLimit}}
								<span class="credits_data_rate_details_numbers_probes-count">
									(-{{consumedRateLimit}})
								</span>
							{{/if}}
						</span>
					</span>
				</div>

				{{#if creditsDataPresented}}
					<div class="credits_data_credits">
						<span class="credits_data_credits_header">
							Credits:
						</span>

						<span class="credits_data_rate_details">
							<span class="credits_data_rate_details_remaining-credits">
								{{remainingCredits}}
							</span>

							{{#if consumedCredits}}
								<span class="credits_data_rate_details_consumed-credits">
									(-{{consumedCredits}})
								</span>
							{{/if}}
						</span>
					</div>
				{{/if}}
			</div>

			<div class="credits_add">
				+ Add Credits
			</div>

			{{#if testInProgress && isInfiniteModeRes}}
				<div class="credits_consuming">
					<img width="14"
						height="14"
						src="{{@shared.assetsHost}}/img/globalping/alert-icon-alt.svg">

					<span>Currently consuming ~{{consumingValue}} credits/minute</span>
				</div>
			{{/if}}
		</div>
	{{/if}}
</div>

<script>
	const tooltip = require('../../assets/js/decorators/tooltip');

	component.exports = {
		decorators: {
			tooltip,
		},
		data () {
			return {
				consumingValue: 40,
				remainingRequests: null,
				availableRequests: null,
				consumedRateLimit: null,
				remainingCredits: null,
				consumedCredits: -16,
				resetsInStr: '',
				creditsDataPresented: false,
			};
		},
		oninit () {
			if (!Ractive.isServer) {
				this.observe('rateCreditsData', (rateCreditsData) => {
					if (rateCreditsData) {
						// handle RateLimit headers
						this.set('remainingRequests', rateCreditsData['x-ratelimit-remaining']);
						this.set('availableRequests', rateCreditsData['x-ratelimit-limit']);
						this.set('resetsInStr', this.createResetInStr(rateCreditsData['x-ratelimit-reset']));

						// handle Credits headers
						if (typeof rateCreditsData['x-credits-remaining'] !== 'undefined') {
							this.set('creditsDataPresented', true);
							this.set('consumedRateLimit', rateCreditsData.probeCount - rateCreditsData['x-credits-consumed']);
							this.set('consumedCredits', rateCreditsData['x-credits-consumed']);
							this.set('remainingCredits', rateCreditsData['x-credits-remaining']);
						} else {
							this.set('creditsDataPresented', false);
						}
					}
				});
			}
		},
		createResetInStr (seconds) {
			let minutes = seconds / 60;

			if (minutes < 1) {
				return '< 1 minute';
			}

			return `${Math.ceil(minutes)} minutes`;
		},
	};
</script>
