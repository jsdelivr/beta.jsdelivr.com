<div class="c-network-provider-stats">
	<div class="block">
		<h3>Requests Served</h3>

		<div class="table">
			<div class="bandwidth-stats">
				<div class="card-icon">
					<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/request.svg">
				</div>

				<div class="card-main-stat text-table-number">
					{{@this.prettifyNumbersToDisplay(requestsData.total)}}
				</div>

				<div class="card-growth">
					<div class="{{requestsData.growth < 0 ? 'growth-negative' : 'growth-positive'}}">
						<span class="text-table-number">
							{{#if requestsData.growth > 0}}+{{/if}}{{@this.prettifyGrowthToDisplay(requestsData.growth)}}%
						</span>
					</div>

					<span>{{period}}ly {{requestsData.growth < 0 ? 'decline' : 'growth'}}</span>
				</div>
			</div>

			<div class="bandwidth-list">
				{{#each requestsData.statsList}}
					<div class="bandwidth-list_item">
						<div class="bandwidth-list_item_provider">
							<img width="20" height="20" src='{{@shared.assetsHost}}{{svg}}'>
							<span >{{name}}</span>
						</div>

						<div class="bandwidth-list_item_provider-stats">
							<div class="bandwidth-list_item_provider-stats_value text-table-number">
								{{@this.prettifyNumbersToDisplay(total)}}
							</div>

							<div class="percentage-bar">
								<div class="percentage-bar_filled" style="width: {{percentage}}; background: {{color}}"></div>
							</div>

							<div class="interest text-table-number">{{@this.prettifyGrowthToDisplay(interest)}}%</div>
						</div>
					</div>
				{{/each}}
			</div>
		</div>
	</div>

	<div class="block">
		<h3>Bandwidth</h3>

		<div class="table">
			<div class="bandwidth-stats">
				<div class="card-icon">
					<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/transfer.svg">
				</div>

				<div class="card-main-stat text-table-number">
					{{ _.formatBytesWithUnit(bandwidthData.total, 'TB') }}
				</div>

				<div class="card-growth">
					<div class="{{bandwidthData.growth < 0 ? 'growth-negative' : 'growth-positive'}}">
						<span class="text-table-number">
							{{#if bandwidthData.growth > 0}}+{{/if}}{{@this.prettifyGrowthToDisplay(bandwidthData.growth)}}%
						</span>
					</div>

					<span>{{period}}ly {{bandwidthData.growth < 0 ? 'decline' : 'growth'}}</span>
				</div>
			</div>

			<div class="bandwidth-list">
				{{#each bandwidthData.statsList}}
					<div class="bandwidth-list_item">
						<div class="bandwidth-list_item_provider">
							<img width="20" height="20" src='{{@shared.assetsHost}}{{svg}}'>
							<span >{{name}}</span>
						</div>

						<div class="bandwidth-list_item_provider-stats">
							<div class="bandwidth-list_item_provider-stats_value text-table-number">
								{{ _.formatBytesWithUnit(total, 'TB') }}
							</div>

							<div class="percentage-bar">
								<div class="percentage-bar_filled" style="width: {{percentage}}; background: {{color}}"></div>
							</div>

							<div class="interest text-table-number">{{@this.prettifyGrowthToDisplay(interest)}}%</div>
						</div>
					</div>
				{{/each}}
			</div>
		</div>
	</div>
</div>

<script>
	const _ = require('../../public/js/_');
	const http = require('../../public/js/utils/http');
	const providersJson = require('../../public/json/net-providers.json');

	component.exports = {
		data () {
			return {
				_,
				requestsData: {
					total: 0,
					growth: 0,
					statsList: [],
				},
				bandwidthData: {
					total: 0,
					growth: 0,
					statsList: [],
				},
			};
		},
		oninit () {
			if (!Ractive.isServer) {
				this.observe('period', (period) => {
					http.fetchNetworkProviderStats(period).then(({ hits, bandwidth }) => {
						this.animate('requestsData', this.processStats(hits));
						this.animate('bandwidthData', this.processStats(bandwidth));
					});
				});
			}
		},
		processStats (data) {
			let { providers, total, prev } = data;
			let result = {
				total: 0,
				growth: 0,
				statsList: [],
			};

			providers.forEach((provider, idx) => {
				let providerData = providersJson[provider.code] ?? {};
				let svg = providerData.imgPath;
				let color = providerData.color;
				let name = providerData.name;
				let stat = providers[idx];

				let interest = this.calcGrowth(stat.total, stat.prev.total);
				let percentage = this.calcPercentage(stat.total, total);

				result.statsList.push({
					svg,
					name,
					color,
					interest,
					total: stat.total,
					percentage,
				});
			});

			result.statsList.sort((a, b) => b.total - a.total);
			result.total = total;
			result.growth = this.calcGrowth(total, prev.total);

			return result;
		},
		calcGrowth (cur, prev) {
			return prev ? (cur - prev) * 100 / prev : 100;
		},
		calcPercentage (provTotal, overallTotal) {
			let percentage = Number((provTotal * 100 / overallTotal).toFixed(1));

			return percentage < 1 ? '1%' : percentage + '%';
		},
		prettifyNumbersToDisplay (num) {
			return _.formatNumberWithSpace(Math.round(num));
		},
		prettifyGrowthToDisplay (growth) {
			return Number(growth) !== 0 ? growth.toFixed(1) : 0;
		},
	};
</script>
